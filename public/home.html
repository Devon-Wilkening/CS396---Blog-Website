<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>396 Project 2 - Blog</title>
    <link rel="stylesheet" href="styling/styles.css">
</head>
<body>
    <header>
        <h1>Welcome to My Blog</h1>
    </header>
    <section id="content">
        <form action="/logout" method="POST" style="display:inline;">
            <button type="submit">Logout</button>
        </form>
        <button id="createPostBtn">Create Post</button>

        <!-- Search Bar -->
        <input type="text" id="tagSearchInput" placeholder="Search by tag...">
        <button id="tagSearchButton">Search</button>
        <!-- Return Home -->
        <button id="returnHomeButton" style="display:none;">Return Home</button>

        <div id="posts"></div>
    </section>
    <script src="app.js"></script>
    <script>
        // Fetch and display all posts
        function loadPosts() {
            fetch('/posts')
                .then(response => response.json())
                .then(posts => {
                    const postsDiv = document.getElementById('posts');
                    postsDiv.innerHTML = ''; // Clear previous posts
                    posts.forEach(post => {
                        const postDiv = document.createElement('div');

                        // Fetch associated tags for the post
                        fetch(`/posts/${post.id}/tags`)
                            .then(response => response.json())
                            .then(tags => {
                                const tagList = tags.map(tag => tag.name).join(', ');

                                // Create buttons for editing and deleting
                                const editButton = document.createElement('button');
                                editButton.textContent = 'Edit';
                                editButton.onclick = () => {
                                    // Redirect to the edit page
                                    window.location.href = `/edit-post/${post.id}`;
                                };

                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete';
                                deleteButton.onclick = () => deletePost(post.id);

                                // Create comment section
                                const commentInput = document.createElement('input');
                                commentInput.placeholder = 'Add a comment...';
                                commentInput.type = 'text';
                                commentInput.id = `comment-input-${post.id}`;

                                const commentButton = document.createElement('button');
                                commentButton.textContent = 'Comment';
                                commentButton.onclick = () => addComment(post.id);

                                const commentsDiv = document.createElement('div');
                                commentsDiv.id = `comments-${post.id}`;

                                // Display post content along with its tags
                                postDiv.innerHTML = `
                                    <h2>${post.title}</h2>
                                    <p>${post.content}</p>
                                    <p>Posted by <strong>${post.username}</strong> on ${new Date(post.created_at + 'Z').toLocaleString()}</p>
                                    <p>Tags: ${tagList || 'None'}</p>
                                `;

                                // Append buttons and comment input to the post
                                postDiv.appendChild(editButton);
                                postDiv.appendChild(deleteButton);
                                postDiv.appendChild(commentInput);
                                postDiv.appendChild(commentButton);
                                postDiv.appendChild(commentsDiv);
                                postsDiv.appendChild(postDiv);

                                // Load existing comments for this post
                                loadComments(post.id);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error fetching posts:', error);
                });
        }

        // Function to load comments for a specific post
        function loadComments(postId) {
            fetch(`/posts/${postId}/comments`)
                .then(response => response.json())
                .then(comments => {
                    const commentsDiv = document.getElementById(`comments-${postId}`);
                    commentsDiv.innerHTML = ''; // Clear previous comments
                    comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.innerHTML = `
                            <p><strong>${comment.username}</strong> commented: 
                            "<span id="comment-text-${comment.id}">${comment.comment}</span>" - 
                            <em>${new Date(comment.created_at + 'Z').toLocaleString()}</em></p>
                        `;

                        // Create Edit button
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit Comment';
                        editButton.onclick = () => {
                            const newComment = prompt('Edit your comment:', comment.comment);
                            if (newComment !== null && newComment.trim() !== '') {
                                editComment(comment.id, postId, newComment);
                            }
                        };

                        // Create Delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete Comment';
                        deleteButton.onclick = () => deleteComment(comment.id, postId);

                        commentDiv.appendChild(editButton);
                        commentDiv.appendChild(deleteButton);
                        commentsDiv.appendChild(commentDiv);
                    });
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                });
        }

        // Function to add a comment
        function addComment(postId) {
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const comment = commentInput.value;

            if (comment.trim() === '') {
                alert('Comment cannot be empty!');
                return;
            }

            fetch(`/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add comment');
                }
                commentInput.value = ''; // Clear the input
                loadComments(postId); // Reload comments after adding
            })
            .catch(error => {
                console.error('Error adding comment:', error);
            });
        }

        function editComment(commentId, postId, newComment) {
            fetch(`/posts/${postId}/comments/${commentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment: newComment })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to edit comment');
                    });
                }
                loadComments(postId); // Reload comments after editing
            })
            .catch(error => {
                alert(error.message); // Display the error message to the user
                console.error('Error editing comment:', error);
            });
        }

        function deleteComment(commentId, postId) {
            fetch(`/posts/${postId}/comments/${commentId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to delete comment');
                    });
                }
                // Reload comments after deletion
                loadComments(postId);
            })
            .catch(error => {
                alert(error.message); // Display the error message to the user
                console.error('Error deleting comment:', error);
            });
        }


        // Function to search posts by tag
        function searchByTag(tag) {
            fetch(`/posts/tag/${tag}`)
                .then(response => response.json())
                .then(posts => {
                    const postsDiv = document.getElementById('posts');
                    postsDiv.innerHTML = ''; // Clear previous posts
                    if (posts.length === 0) {
                        postsDiv.innerHTML = '<p>No posts found for this tag.</p>';
                    } else {
                        posts.forEach(post => {
                            const postDiv = document.createElement('div');
                            postDiv.innerHTML = `
                                <h2>${post.title}</h2>
                                <p>${post.content}</p>
                                <p>Posted by <strong>${post.username}</strong> on ${new Date(post.created_at + 'Z').toLocaleString()}</p>
                            `;
                            postsDiv.appendChild(postDiv);
                        });
                    }
                    // Show the return home button
                    document.getElementById('returnHomeButton').style.display = 'inline-block';
                })
                .catch(error => {
                    console.error('Error fetching posts by tag:', error);
                });
        }
        
        document.getElementById('returnHomeButton').onclick = function() {
            document.getElementById('tagSearchInput').value = ''; // Clear the search input
            document.getElementById('returnHomeButton').style.display = 'none'; // Hide the return button
            loadPosts(); // Reload all posts
        };

        document.getElementById('tagSearchButton').onclick = function() {
            const tag = document.getElementById('tagSearchInput').value.trim();
            if (tag !== '') {
                searchByTag(tag);
            }
        };

        document.getElementById('createPostBtn').onclick = function() {
            window.location.href = '/create-post';
        };

        // Load posts on page load
        document.addEventListener('DOMContentLoaded', loadPosts);
    </script>
</body>
</html>
